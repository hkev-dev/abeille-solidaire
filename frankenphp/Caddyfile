{
	{$CADDY_GLOBAL_OPTIONS}

	frankenphp {
		{$FRANKENPHP_CONFIG}
	}
}

{$CADDY_EXTRA_CONFIG}

{$SERVER_NAME:localhost} {
	log {
		{$CADDY_SERVER_LOG_OPTIONS}
	}

	# Force HTTPS and enable HTTP/3
	tls {
		protocols tls1.2 tls1.3
	}
	protocols h1 h2 h3

	root /app/public
	encode zstd br gzip

	vulcain

	# Security headers
	header {
		# Enable HSTS
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		# Prevent clickjacking
		X-Frame-Options "SAMEORIGIN"
		# Prevent XSS attacks
		X-XSS-Protection "1; mode=block"
		# Prevent MIME-sniffing
		X-Content-Type-Options "nosniff"
		# Content Security Policy
		Content-Security-Policy "upgrade-insecure-requests"
		# Referrer Policy
		Referrer-Policy "strict-origin-when-cross-origin"
		# Permissions Policy
		Permissions-Policy "browsing-topics=()"
	}

	# Handle uploads directory
	handle /uploads/* {
		root * /app/public
		file_server
	}

	{$CADDY_SERVER_EXTRA_DIRECTIVES}

	@phpRoute {
		not file {path}
	}
	rewrite @phpRoute index.php

	@frontController path index.php
	php @frontController

	file_server

	# Redirect HTTP to HTTPS
	@http {
		protocol http
	}
	redir @http https://{host}{uri} permanent
}
