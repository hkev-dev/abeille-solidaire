{% extends 'public/base.html.twig' %}

{% block title %}Complete Registration - Abeilles Solidaires
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
	<style>
		.payment-option {
			border: 2px solid #e7e7e7;
			padding: 20px;
			margin-bottom: 20px;
			cursor: pointer;
			transition: all 0.3s ease;
		}
		.payment-option:hover {
			border-color: var(--thm-base);
		}
		.payment-option.selected {
			border-color: var(--thm-base);
			background-color: rgba(var(--thm-base-rgb), 0.05);
		}
		#stripe-payment-form {
			min-width: 500px;
			margin: 0 auto;
		}
		#card-element {
			padding: 12px;
			border: 1px solid #e7e7e7;
			background: white;
		}
	</style>
{% endblock %}

{% block content %}
	{% include 'public/components/page-header.html.twig' with {
        title: 'Complete Registration',
        breadcrumbs: [
            {label: 'Home', path: 'landing.home'},
            {label: 'Register', path: 'app.register'},
            {label: 'Payment', path: null}
        ]
    } %}

	<section class="login-register">
		<div class="container">
			<div class="row justify-content-center">
				<div class="col-lg-8">
					{% include 'public/components/flash-messages.html.twig' %}

					<div class="text-center mb-4">
						<h3 class="login-register__title">Complete Your Registration</h3>
						<p>Please select your preferred payment method to pay the 25€ registration fee</p>
					</div>

					<div class="card card-body mb-4">
						{{ form_start(form, {'attr': {'id': 'payment-selection-form'}}) }}
						{{ form_errors(form) }}

						<div
							class="payment-options">
							{# Credit Card Option #}
							<div class="payment-option" data-payment="stripe">
								<div class="row align-items-center">
									<div class="col-auto">
										<img src="{{ asset('images/payment/stripe.svg') }}" alt="Credit Card" height="80">
									</div>
									<div class="col">
										<h4 class="mb-1">Pay with Credit Card</h4>
										<p class="mb-0 text-muted">Fast and secure payment via Stripe</p>
									</div>
									<div class="col-auto">
										{{ form_widget(form.payment_method.0, {'attr': {'class': 'visually-hidden'}}) }}
										<i class="fas fa-chevron-right text-muted"></i>
									</div>
								</div>
							</div>

							{# Crypto Option - Updated for CoinPayments #}
							<div class="payment-option" data-payment="crypto">
								<div class="row align-items-center">
									<div class="col-auto">
										<img src="{{ asset('images/payment/coinpayments.svg') }}" alt="Cryptocurrency" height="80">
									</div>
									<div class="col">
										<h4 class="mb-1">Pay with Cryptocurrency</h4>
										<p class="mb-0 text-muted">Accept BTC, ETH, LTC, USDT and 175+ other cryptocurrencies via CoinPayments</p>
									</div>
									<div class="col-auto">
										{{ form_widget(form.payment_method.1, {'attr': {'class': 'visually-hidden'}}) }}
										<i class="fas fa-chevron-right text-muted"></i>
									</div>
								</div>
							</div>
						</div>

						{# Hidden Fields and CSRF Token #}
						{{ form_widget(form._csrf_token) }}
						{{ form_end(form) }}

						{# Stripe Payment Form #}
						<form id="stripe-payment-form" class="mt-4" style="display: none;">
							<input type="hidden" name="_csrf_token" value="{{ csrf_token('stripe_payment') }}">
							<div class="mb-4">
								<div id="card-element" class="form-control"></div>
								<div id="card-errors" class="invalid-feedback" style="display: none;"></div>
							</div>

							<button type="submit" class="thm-btn login-register__btn w-100" disabled>
								<span class="spinner-border spinner-border-sm me-2 d-none" role="status"></span>
								Pay 25€ with Card
							</button>
						</form>

						{# Crypto Payment Form - Updated for CoinPayments #}
						<form id="crypto-payment" action="{{ path('app.registration.payment.crypto', {'id': user.id}) }}" method="POST" class="mt-4 text-center" style="display: none;">
							<input type="hidden" name="_csrf_token" value="{{ csrf_token('crypto_payment') }}">
							<div class="mb-3">
								<p class="text-muted">You will be redirected to CoinPayments to complete your cryptocurrency payment securely</p>
								<small class="d-block mt-2">
									<i class="fas fa-info-circle me-1"></i>
									Supported cryptocurrencies include Bitcoin, Ethereum, Litecoin, USDT, and many more
								</small>
							</div>
							<button type="submit" class="thm-btn login-register__btn">
								<i class="fab fa-bitcoin me-2"></i>
								Pay 25€ with Cryptocurrency
							</button>
						</form>
					</div>

					<div class="text-center mt-4">
						<p class="text-muted mb-0">
							<i class="fas fa-lock me-2"></i>
							Your payment is secured with end-to-end encryption
						</p>
					</div>
				</div>
			</div>
		</div>
	</section>
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<script src="https://js.stripe.com/v3/"></script>
	<script type="module">
		import {PaymentProcessor} from '{{ asset('js/payment-processing.js') }}';

const processor = new PaymentProcessor({
stripePublicKey: '{{ stripe_public_key }}',
amount: 25,
userEmail: '{{ user.email }}',
returnUrl: '{{ path("app.waiting_room", {id: user.id}) }}',
createIntentUrl: '{{ path("app.registration.payment", {id: user.id}) }}',
csrf: {
stripeToken: '{{ csrf_token('stripe_payment') }}',
cryptoToken: '{{ csrf_token('crypto_payment') }}'
}
});

processor.initialize();
	</script>

{% endblock %}