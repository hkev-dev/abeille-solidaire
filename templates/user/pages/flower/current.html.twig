{% extends 'user/layouts/default.html.twig' %}

{% set page_title = 'Ma Fleur Actuelle - ' ~ flower.name %}

{% block content %}
    <div class="container-fixed">
        {# Enhanced Flower Timeline Navigation #}
        <div class="relative mb-12 py-8">
            {# Background Line #}
            <div class="absolute inset-0 flex items-center">
                <div class="w-full h-1 bg-gray-100 rounded-full"></div>
            </div>

            {# Flowers Timeline #}
            <div class="relative flex justify-between px-2">
                {% for f in allFlowers %}
                    {% set isActive = f.id == flower.id %}
                    {% set isCompleted = f.id < flower.id %}
                    {% set isNext = f.id == flower.id + 1 %}
                    
                    <div class="group relative">
                        {# Connection Lines #}
                        {% if not loop.last %}
                            <div class="absolute top-1/2 left-[4.5rem] w-full h-1 
                                {{ isCompleted ? 'bg-success' : 'bg-gray-200' }}">
                            </div>
                        {% endif %}

                        {# Flower Badge #}
                        <div class="relative flex flex-col items-center">
                            {# Main Circle #}
                            <div class="w-20 h-20 rounded-full flex items-center justify-center
                                {{ isActive ? 'bg-primary ring-4 ring-primary/20' :
                                   isCompleted ? 'bg-success' :
                                   isNext ? 'bg-warning' :
                                   'bg-gray-100' }}
                                transform transition-all duration-500 group-hover:scale-105 z-10">

                                {# Inner Circle #}
                                <div class="w-16 h-16 rounded-full bg-white flex items-center justify-center
                                    transform transition-transform duration-500 group-hover:rotate-45">
                                    <span class="ki-duotone ki-abstract-36 text-2xl transform transition-transform duration-500 group-hover:-rotate-45
                                        {{ isActive ? 'text-primary' :
                                           isCompleted ? 'text-success' :
                                           isNext ? 'text-warning' : 'text-gray-400' }}">
                                    </span>
                                </div>

                                {# Status Badge #}
                                <div class="absolute right-0 top-1 z-20
                                    {{ isActive ? 'animate-bounce' : 'transform transition-transform group-hover:scale-110' }}">
                                    {% if isActive %}
                                        <div class="w-6 h-6 rounded-full bg-primary flex items-center justify-center ring-2 ring-white">
                                            <span class="ki-solid ki-star text-white text-xs"></span>
                                        </div>
                                    {% elseif isCompleted %}
                                        <div class="w-6 h-6 rounded-full bg-success flex items-center justify-center">
                                            <span class="ki-solid ki-check text-white text-xs"></span>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            {# Flower Info #}
                            <div class="mt-4 text-center transform transition-all duration-300 
                                {{ isActive ? 'translate-y-0 opacity-100' : 'group-hover:-translate-y-1' }}">
                                <span class="block text-sm font-semibold mb-1
                                    {{ isActive ? 'text-primary' :
                                       isCompleted ? 'text-success' :
                                       isNext ? 'text-warning' : 'text-gray-400' }}">
                                    {{ f.name }}
                                </span>
                                <div class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                    {{ isActive ? 'bg-primary/10 text-primary' :
                                       isCompleted ? 'bg-success/10 text-success' :
                                       isNext ? 'bg-warning/10 text-warning' : 'bg-gray-100 text-gray-400' }}">
                                    {{ f.donationAmount|number_format(2) }} €
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            {# Left Column - Children Slots #}
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden h-full">
                    {# Header with Stats #}
                    <div class="p-6 flex flex-col h-full">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">Mes Filleuls Directs</h3>
                                <p class="text-sm text-gray-500 mt-1">{{ flower.name }} - Niveau {{ userDepth + 1 }}</p>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="px-4 py-2 bg-primary/10 rounded-lg">
                                    <span class="text-sm font-medium text-primary">{{ matrixPositions|length }}/4</span>
                                    <span class="text-xs text-gray-500 ml-1">Places occupées</span>
                                </div>
                            </div>
                        </div>

                        {# Children Slots Grid - Flex-grow to take remaining space #}
                        <div class="grid grid-cols-4 gap-6 flex-grow">
                            {% for i in 1..4 %}
                                {% set position = matrixPositions[i-1]|default(null) %}
                                <div class="relative bg-white rounded-xl border-2 
                                    {{ position ? 'border-success shadow-sm' : 'border-dashed border-gray-300' }}
                                    p-4 flex flex-col items-center justify-center transition-all duration-300
                                    {{ position ? 'hover:shadow-md hover:scale-105' : '' }}">
                                    
                                    {% if position %}
                                        <div class="absolute -top-2 -right-2 w-6 h-6 bg-success text-white rounded-full 
                                            flex items-center justify-center text-xs font-semibold shadow-sm">
                                            {{ i }}
                                        </div>
                                        <div class="w-16 h-16 rounded-full bg-success/10 flex items-center justify-center mb-3
                                            transform transition-all duration-300 group-hover:rotate-12">
                                            <span class="ki-duotone ki-profile-circle text-success text-3xl"></span>
                                        </div>
                                        <span class="text-sm font-medium text-gray-900">
                                            {{ position.firstName }} {{ position.lastName }}
                                        </span>
                                        <span class="text-xs text-gray-500 mt-1">Niveau {{ position.depth + 1 }}</span>
                                    {% else %}
                                        <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mb-3 
                                            border-2 border-dashed border-gray-300">
                                            <span class="ki-duotone ki-plus text-gray-400 text-3xl"></span>
                                        </div>
                                        <span class="text-sm text-gray-400">Position Disponible</span>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            {# Right Column - Progress Stats #}
            <div class="h-full">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden p-6 h-full flex flex-col">
                    <h3 class="text-lg font-semibold text-gray-900 mb-6">Progression {{ flower.name }}</h3>
                    
                    {# Main Progress Circle - With flex-grow to center vertically #}
                    <div class="flex-grow flex flex-col justify-center">
                        <div class="relative w-full aspect-square max-w-[200px] mx-auto mb-6">
                            <div class="absolute inset-0 flex items-center justify-center">
                                <svg class="transform -rotate-90 w-full h-full">
                                    <circle cx="50%" cy="50%" r="45%" stroke-width="8%" 
                                            stroke="currentColor" fill="none" 
                                            class="text-primary/10">
                                    </circle>
                                    <circle cx="50%" cy="50%" r="45%" stroke-width="8%" 
                                            stroke="currentColor" fill="none" 
                                            stroke-dasharray="283"
                                            stroke-dashoffset="{{ 283 - (283 * progress.percentage / 100) }}"
                                            class="text-primary transition-all duration-1000">
                                    </circle>
                                </svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                    <span class="text-3xl font-bold text-primary">{{ progress.received }}/4</span>
                                    <span class="text-sm text-gray-500">Dons reçus</span>
                                </div>
                            </div>
                        </div>

                        {# Stats Grid #}
                        <div class="grid grid-cols-2 gap-4 mt-auto">
                            <div class="p-4 rounded-xl bg-success/10">
                                <div class="text-sm text-gray-600">Total Reçu</div>
                                <div class="text-lg font-semibold text-success">
                                    €{{ totalReceivedInFlower|number_format(2) }}
                                </div>
                            </div>
                            <div class="p-4 rounded-xl bg-primary/10">
                                <div class="text-sm text-gray-600">Cycles Complétés</div>
                                <div class="text-lg font-semibold text-primary">
                                    {{ completedCycles }}/10
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
