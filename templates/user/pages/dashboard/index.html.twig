{% extends 'user/layouts/default.html.twig' %}

{% set page_title = 'Tableau de bord' %}

{% block content %}
	<div
		class="container-fixed">
		{# Header Stats #}
		<div
			class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
			{# Wallet Balance #}
			<div class="card">
				<div class="card-body">
					<div class="flex items-center justify-between mb-2">
						<h3 class="text-gray-600">Solde du Portefeuille</h3>
						<span class="text-primary ki-duotone ki-wallet text-2xl"></span>
					</div>
					<div class="text-2xl font-semibold">€{{ walletBalance|number_format(2) }}</div>
				</div>
			</div>

			{# Current Flower #}
			<div class="card">
				<div class="card-body">
					<div class="flex items-center justify-between mb-2">
						<h3 class="text-gray-600">Fleur Actuelle</h3>
						<span class="text-success ki-duotone ki-flower2 text-2xl"></span>
					</div>
					<div class="text-2xl font-semibold">{{ currentFlower ? currentFlower.name : 'Aucune' }}</div>
				</div>
			</div>

			{# Total Donations #}
			<div class="card">
				<div class="card-body">
					<div class="flex items-center justify-between mb-2">
						<h3 class="text-gray-600">Total Reçu</h3>
						<span class="text-warning ki-duotone ki-gift text-2xl"></span>
					</div>
					<div class="text-2xl font-semibold">€{{ totalDonationsReceived|number_format(2) }}</div>
				</div>
			</div>

			{# Referrals #}
			<div class="card">
				<div class="card-body">
					<div class="flex items-center justify-between mb-2">
						<h3 class="text-gray-600">Parrainages Directs</h3>
						<span class="text-info ki-duotone ki-people text-2xl"></span>
					</div>
					<div class="text-2xl font-semibold">{{ referralCount }}</div>
				</div>
			</div>
		</div>

		<div
			class="grid grid-cols-1 lg:grid-cols-3 gap-6">
			{# Left Column #}
			<div
				class="lg:col-span-2">
				{# Flower Progress #}
				<div class="card mb-6">
					<div class="card-header">
						<h3 class="card-title">Progression de la Fleur</h3>
					</div>
					<div class="card-body">
						<div class="relative pt-1">
							<div class="flex mb-2 items-center justify-between">
								<div>
									<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-primary bg-primary-light">
										Progression
									</span>
								</div>
								<div class="text-right">
									<span class="text-xs font-semibold inline-block text-primary">
										{{ flowerProgress.received }}/4 Dons
									</span>
								</div>
							</div>
							<div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-primary-light">
								<div style="width:{{ (flowerProgress.received / 4) * 100 }}%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-primary"></div>
							</div>
						</div>
					</div>
				</div>

				{# Recent Donations #}
				<div class="card card-table">
					<div class="card-header">
						<h3 class="card-title">Dons Récents</h3>
					</div>
					<div class="card-body p-0">
						<table class="table table-border min-w-full divide-y divide-gray-200">
							<thead>
								<tr>
									<th class="text-left text-xs font-medium text-gray-500 uppercase">Type</th>
									<th class="text-left text-xs font-medium text-gray-500 uppercase">Montant</th>
									<th class="text-left text-xs font-medium text-gray-500 uppercase">Date</th>
								</tr>
							</thead>
							<tbody class="divide-y divide-gray-200">
								{% for donation in recentDonations %}
									<tr>
										<td class="whitespace-nowrap text-sm">
											{% if donation.donationType == 'direct' %}Don Direct
												{% elseif donation.donationType == 'solidarity' %}Don Solidaire
												{% elseif donation.donationType == 'referral_placement' %}Placement Parrainage
												{% elseif donation.donationType == 'registration' %}Inscription
												{% elseif donation.donationType == 'supplementary' %}Don Supplémentaire
											{% else %}
												{{ donation.donationType|title }}
											{% endif %}
										</td>
										<td class="whitespace-nowrap text-sm">€{{ donation.amount }}</td>
										<td class="whitespace-nowrap text-sm">{{ donation.transactionDate|date('d M Y') }}</td>
									</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
				</div>
			</div>

			{# Right Column #}
			<div
				class="lg:col-span-1">
				{# Account Status #}
				<div class="card mb-6">
					<div class="card-header">
						<h3 class="card-title">État du Compte</h3>
					</div>
					<div class="card-body space-y-4">
						<div class="flex items-center justify-between">
							<span class="text-gray-600">Vérification KYC</span>
							{% if isKycVerified %}
								<span class="px-2 py-1 text-xs rounded-full text-success bg-success-light">Vérifié</span>
							{% else %}
								<span class="px-2 py-1 text-xs rounded-full text-danger bg-danger-light">En Attente</span>
							{% endif %}
						</div>
						<div class="flex items-center justify-between">
							<span class="text-gray-600">Adhésion</span>
							{% if currentMembership %}
								<span class="px-2 py-1 text-xs rounded-full text-success bg-success-light">Active</span>
							{% else %}
								<span class="px-2 py-1 text-xs rounded-full text-warning bg-warning-light">Requise</span>
							{% endif %}
						</div>
					</div>
				</div>

				{# Direct Referrals #}
				<div class="card">
					<div class="card-header">
						<h3 class="card-title">Filleuls Directs</h3>
					</div>
					<div class="card-body space-y-4">
						{% for referral in directReferrals %}
							<div class="flex items-center space-x-3">
								{% if referral.avatar %}
									<img src="{{ vich_uploader_asset(referral, 'avatarFile') }}" class="w-10 h-10 rounded-full">
								{% else %}
									<div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center">
										<span class="text-gray-500 text-sm">{{ referral.firstName|first }}{{ referral.lastName|first }}</span>
									</div>
								{% endif %}
								<div>
									<div class="font-medium">{{ referral.fullName }}</div>
									<div class="text-sm text-gray-500">{{ referral.currentFlower ? referral.currentFlower.name : 'Pas de Fleur' }}</div>
								</div>
							</div>
						{% endfor %}
					</div>
				</div>
			</div>
		</div>
	</div>
{% endblock %}
